
# 1장 근접성 서비스

## 1단계: 문제 이해 및 설계범위 확정

* 검색 반경(radius)을 지정할 수 있어야 하는가?
  * 주어진 반경 내의 사업장만 대상으로 한다.
* 최대 허용 반경은 얼마인가?
  * 20km 로 가정한다.
* 사용자가 UI에서 검색 반경을 변경할 수 있어야 하는가?
  * 변경 가능해야 한다.
* 사업장 정보는 어떻게 시스템에 추가/삭제/갱신 되는가?
  * 소유주가 시스템에 추가/삭제/갱신할 수 있다.
  * 새로 추가/갱신한 정보는 다음날까지 반영되어야 한다.
* 이동중에 웹을 이용 한다면 검색 결과 화면을 갱신해야 하는가?
  * 상시적으로 갱신할 필요 없다.

### 기능 요구사항

* 사업장 목록 반환 (by 사용자의 위치 && 검색반경 매치)
* 소유주가 사업장 정보를 추가/삭제/갱신 가능, 실시간 반영 X
* 사업장 상세 정보 보기

### 비기능 요구사항

* 낮은 응답 지연시간
* 데이터 보호 (위치정보)
* 고가용성, 규모 확장성

### 개략적 규모 추정

* 1일 = 86,400초 = 10^5초
* (DAU 1억명 * 하루에 5회) / 10^5초 = QPS 5000

## 2단계: 개략적 설계안 제시 및 동의 구하기

### API 설계

GET /v1/search/nearby?latitude=&longitude=&radius=

* latitude : 위도
* longitude : 경도
* radius : 범위

```json
{ "total": 10, "businesses": [] }
```

### 사업장 관련 API

/v1/businesses CRUD 4종 API

### 데이터 모델

쓰기보다 읽기 연산 비율이 높아 Mysql 로 선정한다. (주변사업장 검색, 사업장 정보 확인)

### 데이터 스키마

* business 테이블
  * business_id
  * address
  * city
  * state
  * latitude
  * longtitude
* 지리적 위치 색인 테이블
  * 생략

### 개략적 설계

[그림 1.2]

* 컴포넌트 : 로드밸런서, 위치 기반 서비스(LBS), 사업장 서비스 (CRUD)
* DB 클러스터 : master-slave 구성, 복제지연 감안 가능

### 주변 사업장 검색 알고리즘

* 레디스 지오해시
* Postgres 사용 (PostGIS 확장 설치)

DB 나열보다 알고리즘을 설명하는 것이 좋음

#### 방안1 : 2차원 검색

* 원 안에 놓인 사업장 검색, 단순하다는 문제
* (위도 BETWEEN 위도 - 반경 and 위도 + 반경) AND (경도 BETWEEN 경도 - 반경 and 경도 + 반경)
* 위도로 찾은 엄청난 데이터양과, 경도로 찾는 엄청난 데이터양을 각각 찾아야 하는 비효율
* 업계에서 사용하는 일반적 방안
  * 해시 기반 방안
  * 트리 기반 방안

#### 방안2: 균등 격자

#### 방안3

#### 방안4

#### 방안5

## 3단계

## 4단계


