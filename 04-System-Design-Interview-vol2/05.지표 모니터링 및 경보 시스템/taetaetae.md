# 5장 지표 모니터링 및 경보 시스템

- 인프라의 상태를 선명하게 볼 수 있도록 하여 높은 가용성과 안정성을 달성하는데 중추적인 역할
- 1단계 : 문제 이해 및 설계 범위 확정
    - 개략적 요구사항 및 가정
        - 대규모 인프라를 모니터링 해야함
            - DAU 1억명
            - 모니터링 해야하는 지표의 수는 천만개 수준
            - 데이터 보관 1년
            - 수집 이후 그대로는 1주일, 구뒤는 1분단위 변환 30일, 그뒤는 1시간단위 변환 1년간 보관
        - 모니터링 지표
            - cpu
            - 요청수
            - 메모리 사용량
            - 메시지 큐 내의 메시지 수
    - 비 기능 요구사항
        - 규모 확장성
        - 낮은 응답지연 : 대시보드와 경보를 신속하게 처리, 질의에 대한 낮은 응답지연 보장
        - 안정성
        - 유연성
        - 필요 없는 것
            - 로그 모니터링
            - 분산 시스템 추적
- 2단계 : 개략적 설계안 제시 및 동의 구하기
    - 다섯가지 컴포넌트
        - 데이터 수집 : 여러 출처로부터 수집
        - 데이터 전송 : 지표 모니터링 시스템으로  전송
        - 데이터 저장소 : 전송되어 오는 데이터를 정리하고 저장
        - 경보 : 데이터 분석, 이상징후 감지, 다양한 통신 채널로 경보 발송
        - 시각화 : 차트나 그래프
    - 데이터 모델
        - metric_name / labels / timestamp / value
        - 시계열 데이터 : 지표이름 / 태그,레이블 집합 / 지표 값 및 그 타임스탬프의 배열
        - 이 시스템은 언제나 많은 양의 쓰기 연산 부하를 감당해야 하지만, 읽기 연산의부하는 잠시 급증하였다가 곧 사라지곤 함
    - 데이터 저장소 시스템
        - 시계열 데이터 베이스 : InfluxDB, Prometheus
        - 직접 만들거나 구현하려고 하지는 말자. (rdb, NoSQL 등)
    - 개략적 설계안
        - 지표 출처 : 지표 데이터가 만들어 지는 곳(app, db, mq 등)
        - 지표 수집기 : 수집하고 전달
        - 시계열 데이터베이스 : 다량의 시계열 데이터를 분석하고 요약하는데 적합하도록 설계된 질의 데이터베이스
        - 질의 서비스 : 데이터를 질의하고 가져오는 역할
        - 경보 시스템 : 알림
        - 시각화 시스템 : 지표를 다양한 형태의 그래프/차트로 시각화
    - 3단계 : 상세 설계
        - 지표수집
            - 풀 모델 : 프로메테우스
                - 수집해야할 대상을 알아야 하는 단점 > 서비스 디스커버리로 해결(etcd, 주키퍼)
                - 서비스 탐색 서비스와 지표 수집기의 연결
                - 안정 해시링으로 중복 수집 방지
            - 푸시 모델 : 클라우드와치, 그래파이트
                - 에이전트 설치
                - 버퍼 활용
                - 서버 추가/삭제 시 어느정도 유실 가능성
            - 두 모델 장단점이 있음, 상황에 따라 선택이 필요
        - 지표 전송 파이프라인의 규모 확장
            - 지표 수집기는 서버 클러스터의 형태이며 엄청난 양의 데이터를 받아 처리해야 함
            - 데이터 손실 발생 가능성
            - 카프카를 통해 규모 확장
                - 대역폭 요구사항에 따라 파티션의 수 설정
                - 이름에 따라 파티션 배치, 세분화
                - 대안으로 페북의 메모리 기반 시계열 데이터 베이스 시스템 : 고릴라
                    - 높은 수준의 쓰기 연산 가용성 유지
        - 데이터 집계지점
            - 수집 에이전트가 집계
                - 복잡한 로직 추가 어려움
                - 어떤 카운터 값을 분 단위로 집계하는 정도
            - 데이터 수집 파이프라인에서 집계
                - 스트림 프로세싱 엔진 필요
                - 늦게 도착하는 데이터, 원본 데이터 보관을 하지 않기에 정밀도나 유연성 측면에서 손해
            - 질의 시에 집계
                - 질의시 계산하기 때문에 속도가 느림
        - 질의 서비스
            - 클라이언트와 데이터베이스 사이의 결합도를 낮춤 > 시계열 데이터 베이스 교체가능
            - 캐시로 질의 서비스 성능 확보
            - 질의어 : 자체 질의어 제공, SQL은 복잡함
        - 저장소 계층
            - 데이터 인코딩 및 압축
            - 다운 샘플링 : 데이터의 해상도를 낮춰 저장소 요구량을 줄이는 기법
            - 냉동 저장소 : 잘 사용되지 않는 비활성 상태 데이터 보관 (hot/warm/cold : https://www.elastic.co/kr/blog/implementing-hot-warm-cold-in-elasticsearch-with-index-lifecycle-management )
        - 졍보 시스템
            - 다양한 채널로 전달. 시계열 데이터베이스와 통합된 경우 많음. 구매 vs 구현
        - 시각화 시스템
            - 가급적 사용 시스템 활용. 시계열 데이터 베이스 시스템과의 궁합 고려
    - 4단계 : 마무리
        - 지표 데이터 수집 모델 : 풀/푸시
        - 카프카를 활용한 규모 확장 방안
        - 최적 시계열 데이터베이스의 선정
        - 다운 샘플링을 통한 데이터 크기 절감
        - 경보/시각화 시스템 : 구현 vs 구입