# 6장. 서버 메트릭
- MySQL 서버 성능을 모니터링하고 관리하기 위한 다양한 메트릭과 그 중요성
- 서버 메트릭을 적절하게 이해하고 활용함으로써, 서버의 성능을 유지하고 최적화할 수 있는 방법

## 6-1. 쿼리 성능 대 서버 성능
- 동시성과 경합
  - MySQL 서버에서 여러 쿼리가 동시에 실행될 때 발생하는 자원 경쟁을 의미
  - 이러한 경합은 성능 저하를 초래할 수 있고, 경합이 심해지면 MySQL 서버의 성능이 급격히 저하될 수 있음
  - 동시성은 서버가 여러 작업을 동시에 처리하는 능력을 의미하며, 이는 자원 경합을 발생시킬 수 있음
- 튜닝
  - MySQL 서버의 성능을 최적화하기 위해 서버 설정을 조정하는 과정을 의미
  - 쿼리 성능 및 서버 성능을 모두 향상시키기 위한 핵심 과정이며, 잘못된 튜닝은 오히려 성능을 저하시킬 수 있음
  - 서버 성능 튜닝은 안정적인 워크로드를 기반으로 수행되어야 하며, 그렇지 않으면 튜닝 효과를 정확히 평가할 수 없음
- 성능 회귀
  - 소프트웨어 업데이트나 변경 후에 성능이 저하되는 현상을 의미
  - 이를 방지하기 위해 변경 전후의 성능을 면밀히 비교하고 분석하는 것이 중요함

## 6-2. 정상과 안정
- 정상
  - 서버가 계획된 성능 범위 내에서 작동하는 상태를 의미
  - 서버가 정상적으로 작동하면 예기치 않은 성능 저하 없이 안정적으로 운영됨
- 안정
  - 서버 성능이 변동 없이 일정하게 유지되는 상태를 의미 
  - 서버가 안정적인 상태를 유지하면 성능 문제를 예측하고 대응하기 쉬워짐

## 6-3. 핵심 성능 지표
- 응답시간
  - 쿼리가 실행되어 결과를 반환하는 데 걸리는 시간을 의미 
  - 낮은 응답시간은 서버 성능이 우수하다는 것을 나타내며, 높은 응답시간은 성능 저하의 징후일 수 있음
- 오류
  - 서버에서 발생하는 쿼리 오류의 빈도를 나타내는 지표 
  - 오류가 증가하면 시스템 안정성이 저하될 수 있으며, 신속한 분석과 수정이 필요함
- QPS
  - 초당 처리되는 쿼리의 수를 의미 
  - 높은 QPS는 서버가 많은 요청을 처리할 수 있음을 나타내지만, 서버 과부하로 이어질 수도 있음
- 실행 중인 스레드
  - 현재 실행 중인 MySQL 서버의 스레드 수를 나타냄 
  - 실행 중인 스레드 수가 많을수록 서버 자원 소모가 증가할 수 있음

## 6-4. 매트릭 필드
- 응답 시간 메트릭
  - 쿼리 실행의 지연 시간에 관한 메트릭 
  - 이 메트릭을 통해 서버 응답성의 효율성을 평가할 수 있음
  - 응답시간 메트릭은 쿼리 실행의 각 단계를 분석하여 성능 병목을 파악하는 데 도움을 줌
- 속도 메트릭
  - 서버가 데이터를 처리하는 속도를 측정하는 메트릭 
  - 처리 속도가 빠를수록 서버 성능이 높음을 의미함
  - 속도 메트릭은 자원 사용률과 밀접한 관계가 있으며, 성능 최적화를 위해서는 속도와 사용률의 균형을 맞춰야 함
- 사용률 메트릭
  - 서버 자원의 사용량을 측정하는 메트릭 
  - 높은 사용률은 자원 소모가 많음을 의미하며, 자원 부족으로 이어질 수 있음
  - 자원 사용률이 높을 경우, 서버 확장 또는 쿼리 최적화를 통해 성능을 개선할 필요가 있음
- 대기 메트릭
  - 서버 자원이 사용 가능해질 때까지 기다리는 시간을 측정하는 메트릭 
  - 대기 시간이 길어지면 성능 병목이 발생할 수 있음
  - 대기 메트릭은 자원 사용률과 직결되며, 대기 시간을 최소화하는 것이 성능 향상의 열쇠임
- 오류 메트릭
  - 서버에서 발생하는 오류의 빈도를 측정하는 메트릭 
  - 오류 빈도가 높아지면 시스템의 신뢰성이 떨어질 수 있음
- 접근 패턴 메트릭
  - 애플리케이션이 MySQL 데이터베이스에 접근하는 방식을 분석하는 메트릭 
  - 접근 패턴을 이해하면 성능 최적화에 필요한 개선점을 찾을 수 있음
  - 서버의 데이터 접근 방식과 쿼리 패턴을 분석하여 성능 개선의 단서
- 내부 메트릭
  - MySQL 서버의 내부 동작을 측정하는 메트릭 
  - 내부 메트릭을 분석하면 서버의 세부적인 성능 문제를 파악할 수 있음

## 6-5. 스펙트라
- 쿼리 응답시간
  - 쿼리의 처리 속도와 관련된 메트릭 스펙트럼 
  - 쿼리 응답시간이 길면 성능 저하의 원인을 분석할 필요가 있음
- 오류
  - 서버에서 발생하는 오류와 관련된 메트릭 스펙트럼 
  - 오류 발생 빈도를 모니터링하여 서버의 안정성을 평가할 수 있음
- 쿼리
  - 실행된 쿼리와 관련된 다양한 메트릭을 포함하는 스펙트럼 
  - 쿼리 성능을 분석하여 최적화할 수 있음
- 스레드와 연결 
  - 서버의 스레드 관리와 연결 상태를 측정하는 메트릭 스펙트럼
  - 스레드와 연결 문제는 서버 성능에 직접적인 영향을 미칠 수 있음 
  - 이 스펙트럼은 서버의 동시성 처리 능력을 분석하고, 자원 경합 문제를 해결하는 데 도움을 줌
- 임시 개체 
  - 임시로 생성된 데이터베이스 개체와 관련된 메트릭 스펙트럼 
  - 임시 개체가 많아지면 서버 성능에 부정적인 영향을 줄 수 있음 
  - 임시 개체 스펙트럼은 서버의 임시 자원 사용을 모니터링하고 최적화하는 데 유용함
- 준비된 명령문 
  - 미리 준비된 SQL 명령문과 관련된 메트릭 스펙트럼 
  - 준비된 명령문이 잘못 사용되면 성능 저하를 초래할 수 있음 
- 잘못된 SELECT 
  - 비효율적인 SELECT 쿼리와 관련된 메트릭 스펙트럼 
  - 비효율적인 SELECT 쿼리는 서버 성능을 저하시키므로 최적화가 필요함 
- 네트워크 처리량 
  - MySQL 서버와 클라이언트 간의 데이터 전송 속도와 관련된 메트릭 스펙트럼 
  - 네트워크 처리량을 모니터링하여 성능 병목을 파악할 수 있음 
  - 네트워크 자원의 효율적인 사용을 보장하고, 서버의 전반적인 성능을 향상시키는 데 기여함
- 복제 
  - MySQL 복제 시스템의 성능과 관련된 메트릭 스펙트럼 
  - 복제 지연이 발생하면 데이터 일관성이 위협받을 수 있음 
- 데이터 크기 
  - 데이터베이스의 크기와 관련된 메트릭 스펙트럼 
  - 데이터 크기가 증가하면 성능 저하의 원인이 될 수 있음
  - 저장소 사용량을 모니터링하고 최적화하여 성능을 유지하는 데 도움을 줌
- InnoDB
  - 변경 내역 목록 길이(HLL)
    - 오래된 데이터의 버전을 유지하는 InnoDB의 트랜잭션 롤백 세그먼트 크기를 의미
    - HLL이 증가하면 장기간 실행되거나 미처리된 트랜잭션이 InnoDB의 청소 작업을 방해하고 있음을 의미하고 이는 디스크 공간 문제나 성능 저하를 초래할 수 있음
    - HLL 값이 비정상적으로 높다면, 장기 실행되거나 중단된 트랜잭션을 찾아 종료해야 하며, 시스템의 트랜잭션 관리 정책을 재검토하는 것이 필요
  - 교착상태
    - 두 개 이상의 트랜잭션이 서로의 잠금을 기다리면서 발생하는 상황
    - InnoDB에서 발생한 교착상태의 수를 기록하며, 잦은 교착상태는 트랜잭션 설계에 문제가 있음을 의미
    - 잠금 경합이 발생하지 않도록 트랜잭션의 잠금 순서를 조정하거나, 잠금을 사용하는 쿼리의 성능을 최적화해야함
  - 행 잠금
    - 특정 행을 잠그기 위해 대기한 시간을 측정
    - 잠금 대기 시간이 길어질수록 트랜잭션 처리 시간이 늘어나고, 시스템 성능에 부정적인 영향을 미칠 수 있음
    - 잠금 시간이 길어지는 트랜잭션을 분석하여 필요하다면 잠금 타임아웃을 설정하거나 쿼리 및 인덱스를 최적화해야 함
  - 데이터 처리량
    - InnoDB가 디스크로부터 데이터를 읽고 쓰는 작업의 수
    - 데이터 처리량이 높아지면 디스크 I/O 부하가 증가할 수 있음
    - 디스크 I/O 병목 현상을 피하기 위해 쿼리 최적화, 인덱스 사용, 하드웨어 업그레이드 등을 고려해야 함
  - IOPS (Input/Output Operations Per Second)
    - 초당 디스크에서 발생하는 읽기 및 쓰기 작업의 수
    - 이 수치가 높으면 디스크 성능에 부담이 될 수 있음
    - 시스템의 IOPS 요구를 충족할 수 있도록 적절한 디스크 성능을 확보하거나, 쿼리 성능을 최적화해야 함
  - 버퍼 풀 효율성
    - 데이터가 디스크에서가 아닌 메모리에서 얼마나 자주 읽히는지
    - 버퍼 풀에서 더 자주 데이터를 읽어들일수록 성능이 향상
  - 페이지 플러싱
    - 버퍼 풀에서 디스크로 플러시된 페이지 수
    - 플러시 작업이 자주 발생하면 디스크 I/O에 과부하가 걸릴 수 있음
  - 트랜잭션 로그
    - 트랜잭션 로그에 대한 쓰기 요청과 실제로 기록된 로그의 수
    - 로그 쓰기 작업이 많아지면 시스템 성능에 부정적인 영향을 줄 수 있음

## 6-6. 모니터링과 경보
- 레졸루션 (Resolution)
  - 메트릭 수집과 보고 빈도를 의미하며, 높은 레졸루션은 더 정확한 실시간 데이터를 제공할 수 있음, 그러나 이는 시스템 자원을 많이 소모할 수 있음
  - 중요한 성능 지표에 대해 최소 5초 간격의 모니터링을 권장하며, 시스템의 부하와 필요에 따라 레졸루션을 조정해야 함
- 헛된 노력(임곗값)
  - 잘못 설정된 임곗값은 불필요한 경보를 초래하여 관리자가 중요하지 않은 문제에 과도하게 반응하게 만들 수 있음, 이는 효율성을 저하시킴
  - 임곗값은 실제로 중요한 문제에 대해서만 경보가 울리도록 신중하게 설정해야 함
- 사용자 경험과 객관적 한계에 대한 경고
  - 경고는 시스템 임곗값을 넘어 사용자 경험에 직접적인 영향을 미치는 지표를 기준으로 설정되어야 함
  - 예를 들어, 응답 시간이나 오류율과 같은 사용자 경험 관련 지표가 이에 해당됨
  - 사용자 경험을 기반으로 경고를 설정하여 실제 시스템 사용자가 체감할 수 있는 문제에 대해 즉각적으로 대응할 수 있도록 해야 함
- 원인과 결과
  - 발생한 문제의 근본 원인을 정확히 분석하여 장기적인 해결책을 마련하는 것이 중요
  - 원인을 분석함으로써 문제의 재발을 방지할 수 있음
  - 문제의 원인을 철저히 조사하고, 단기적 대처뿐만 아니라 근본적인 문제 해결을 통해 시스템 안정성을 향상시켜야 함