# 1장 근접성 서비스

## 1단계 : 문제 이해 및 설계 범위 확정
- 기능 요구사항
  - 사용자의 위치(경도/위도)와 검색 반경 정보에 매치되는 사업장 목록 반환
  - 사업장 소유주가 사업장 정보 관리, 실시간 반영 x
  - 사업장의 상세 정보 조회
- 비기능 (non-functional requirements) 요구사항
  - 낮은 응답지연 (latency)
  - 데이터 보호 (data privacy)
  - 고가용성 (high availability) 및 규모 확장성(scalability)
- 개략적인 추정 (back of the envelope calculation)
  - 일간 능동 사용자(Daily Active User, DAU) : 1억명
  - 등록된 사업장 수 : 2억
  - 1일 = 24시간 x 60분 x 60초 = 86,400초 (대략 100,000)
  - 한 사용자당 하루에 5회 검색
  - QPS = (1억명 x 5회) / 100,000 = 5,000

## 2단계 : 개략적 설계안 제시 및 동의 구하기
- API 설계
  - `GET` /v1/search/nearby 특정 검색기준에 맞는 사업장 목록 반환
    - 페이지 분할 (pagination) 고민 필요
  - `GET` /v1/businesses/:id 특정 사업장의 상세 정보 반환
  - `POST` /v1/businesses 새로운 사업장 추가
  - `PUT` /v1/businesses/:id 사업장 상세 정보 갱신
  - `DELETE` /v1/businesses/:id 특정 사업장 정보 삭제
- 데이터 모델
  - 읽기 연산은 굉장히 자주 수행
    - 주변 사업장 검색
    - 사업장 정보 확인
      > 읽기 연산이 압도적인 시스템에서는 mysql같은 관계형 데이터베이스가 바람직? 왜?
  - 쓰기 연산은 실행 빈도가 낮음
  - 사업장 상세 정보와 지리적 위치 색인 테이블 필요
- 개략적 설계
  - 위치 기반 서비스(location-based service, LBS) 와 사업장 서비스로 구분
  - 로드밸런서로 검색(읽기)과 사업장(쓰기) 트래픽을 구분 및 분산
  - 위치 기반 서비스 (LBS)
    - 쓰기 요청은 없고 읽기 요청만 있음
    - QPS가 높음, 특히 특정 시간대의 인구 밀집 지역일수록 심함
    - 무상태(stateless) 서비스, 수평적 규모 확장이 쉬움
  - 사업장 서비스
    - 쓰기요청, QPS가 높지 않음
    - 고객이 사업장을 조회, 특정 시간대에 QPS가 높아짐
  - 데이터베이스 클러스터
    - 주-부 (primary-secondary) 데이터베이스 형태로 구성
    - 데이터 복제시 지연(delay) 이 발생하지만 문제되는 수준은 아님
  - 규모 확장성
    - 두 서비스(LBS,사업장) 모두 무상태 서비스이므로 확장 가능
    - 클라우드 서버의 경우 여러 지역, 여러 가용성 구역으로 시스템 가용성을 높일 수 있음
    > hpa 확장 말고 축소도 고려 (사용이 안되는 새벽시간) → 최소한의 서버수, 단계적 확장/축소 : 비용 절약
- 주변 사업장 검색 알고리즘
  - 방안 1 : 2차원 검색
  - 방안 2 : 균등 격자
  - 방안 3 : 지오해시
    > geo hash https://geohash.softeng.co/
  - 방안 4 : 쿼드트리
    > 배포 전략, blue/green 으로 한번에 투입시 유입이 갑자기 많이 되어 큰 부하를 입을수 있음
  - 방안 5 : 구글 S2