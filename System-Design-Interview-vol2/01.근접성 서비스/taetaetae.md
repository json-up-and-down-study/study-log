# 1장 근접성 서비스

## 1단계 : 문제 이해 및 설계 범위 확정
- 기능 요구사항
  - 사용자의 위치(경도/위도)와 검색 반경 정보에 매치되는 사업장 목록 반환
  - 사업장 소유주가 사업장 정보 관리, 실시간 반영 x
  - 사업장의 상세 정보 조회
- 비기능 (non-functional requirements) 요구사항
  - 낮은 응답지연 (latency)
  - 데이터 보호 (data privacy)
  - 고가용성 (high availability) 및 규모 확장성(scalability)
- 개략적인 추정 (back of the envelope calculation)
  - 일간 능동 사용자(Daily Active User, DAU) : 1억명
  - 등록된 사업장 수 : 2억
  - 1일 = 24시간 x 60분 x 60초 = 86,400초 (대략 100,000)
  - 한 사용자당 하루에 5회 검색
  - QPS = (1억명 x 5회) / 100,000 = 5,000

## 2단계 : 개략적 설계안 제시 및 동의 구하기
- API 설계
  - `GET` /v1/search/nearby 특정 검색기준에 맞는 사업장 목록 반환
    - 페이지 분할 (pagination) 고민 필요
  - `GET` /v1/businesses/:id 특정 사업장의 상세 정보 반환
  - `POST` /v1/businesses 새로운 사업장 추가
  - `PUT` /v1/businesses/:id 사업장 상세 정보 갱신
  - `DELETE` /v1/businesses/:id 특정 사업장 정보 삭제
- 데이터 모델
  - 읽기 연산은 굉장히 자주 수행
    - 주변 사업장 검색
    - 사업장 정보 확인
      > 읽기 연산이 압도적인 시스템에서는 mysql같은 관계형 데이터베이스가 바람직? 왜?
  - 쓰기 연산은 실행 빈도가 낮음
  - 사업장 상세 정보와 지리적 위치 색인 테이블 필요
- 개략적 설계
  - 위치 기반 서비스(location-based service, LBS) 와 사업장 서비스로 구분
  - 로드밸런서로 검색(읽기)과 사업장(쓰기) 트래픽을 구분 및 분산
  - 위치 기반 서비스 (LBS)
    - 쓰기 요청은 없고 읽기 요청만 있음
    - QPS가 높음, 특히 특정 시간대의 인구 밀집 지역일수록 심함
    - 무상태(stateless) 서비스, 수평적 규모 확장이 쉬움
  - 사업장 서비스
    - 쓰기요청, QPS가 높지 않음
    - 고객이 사업장을 조회, 특정 시간대에 QPS가 높아짐
  - 데이터베이스 클러스터
    - 주-부 (primary-secondary) 데이터베이스 형태로 구성
    - 데이터 복제시 지연(delay) 이 발생하지만 문제되는 수준은 아님
  - 규모 확장성
    - 두 서비스(LBS,사업장) 모두 무상태 서비스이므로 확장 가능
    - 클라우드 서버의 경우 여러 지역, 여러 가용성 구역으로 시스템 가용성을 높일 수 있음
    > hpa 확장 말고 축소도 고려 (사용이 안되는 새벽시간) → 최소한의 서버수, 단계적 확장/축소 : 비용 절약
- 주변 사업장 검색 알고리즘
  - 방안 1 : 2차원 검색
    - xx,xy,yx,yy 기준으로 쿼리 질의
    - 인덱스로 처리한다 해도 각 집합에 속한 데이터의 양 때문에 효율적일 수 없음
  - 방안 2 : 균등 격자
    - 지도를 균등하게 나누어 관리
    - 지점의 분포가 균등하지 못하여 비효율적
  - 방안 3 : 지오해시
    - 사분면으로 나누고 각 격자를 재귀적으로 사분면으로 나누며 반복
    - 원하는 정밀도(precision)을 얻을 때까지 반복
    - 지오해시는 통상적으로 base32을 사용
      - 구글 본사 지오해시 (길이 = 6)
        10011101001001100011111111110 : 9q9hvu
      - 메타 본사 지오해시 (길이 = 6)
        10011101001001100111000111011 : 9q9jhr 
    - geo hash https://geohash.softeng.co/
    - base32 to binary https://www.unitconverters.net/numbers/base-32-to-binary.htm
    - 최적의 정밀도는 사용자가 지정한 반경으로 그린 원을 덮는 최소 크기 격자
    - 격자 가장자리 관련 이슈
      - 아주 가까운 두 위치가 어떤 공통 접두어도 가지지 않는 경우
      - 두 지점이 공통 접두어는 같지만 다른 격자에 놓이는 경우
      - 해결책
        - 인접한 모든 격자의 모든 사업장 정보를 가져옴
        - 상수 시간에 가능한 연산
    - 격자안에 표시할 사업장이 없을 경우
      - 주어진 격자 안 내용만 반환
      - 검색 반경을 키워 검색
  - 방안 4 : 쿼드트리
    - 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할 하는데 흔히 사용되는 자료구조
    - 메모리 안에 들고 있는 자료구조. 데이터베이스가 아님. (LBS 서버에 존재, 서버가 시작하는 시점에 구축)
    - 고려사항
      - 메모리에 들고 있기 때문에 생성 시간 및 용량을 잘 고려 해야 함
      - 배포 전략, blue/green 으로 한번에 투입시 유입이 갑자기 많이 되어 큰 부하를 입을수 있음
      - 추가/삭제 등 쿼드트리 갱신 : 지연, 부하 등
  - 방안 5 : 구글 S2
    - 구글 S2 기하(geometry) 라이브러리
    - 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용하여 1차원 색인화 하는 방안
    - 힐베르트 곡선 상에서 인접한 두 지점은 색인화 이후 1차원 공간 내에서도 인접한 위치에 있다는 특징
  - 지오해시 vs 쿼드트리
    - 지오해시
      - 구현과 사용이 쉽고 트리 구축이 필요 없음
      - 지정 반경 이내 검색 지원
      - 색인 갱신이 쉬움
      - 동적으로 격자 크기 조정이 어려움 
    - 쿼드트리
      - 트리 구축을 위해서 구현이 더 어려움
      - 격자 크기 동적 조정 가능
      - 색인 갱신이 어려움. 트리 하위까지 순회 필요
      - 가까운 순서 기준 조회 가능

## 3단계 : 상세 설계
- 데이터베이스의 규모 확장성
  - 사업장 테이블 : 사업장 ID 기준으로 샤딩
  - 지리정보 색인 테이블
    - 1안 : geohash 와 사업장id 목록을 json으로 관리
    - 2안 : geohash 와 사업장 id별로 하나의 row로 관리
    - 2안 추천 : 업데이트 및 조회 측면에서 이득
  - 샤딩을 해야하는가?
    - 사본 데이터베이스를 구성하여 읽기 트래픽을 분산만 해도 해결될 수도 있음
    - 샤딩 로직이 어플리케이션 계층에 구현해야 하기 때문에 까다로울 수 있음
- 캐시를 도입해야 하는가?
  - 읽기 성능이 병목이라면 사본 데이터베이스를 증설
  - 비용발생 고려
  - 캐시 "키 : 값"
    - 지오해시 : 해당 격자 내의 사업장 ID 목록
    - 사업장 ID : 사업장 정보 객체
- 지역 및 가용성 구역
  - 사용자와 시스템 사이의 물리적 거리 최소화
  - 트래픽을 인구에 따라 고르게 분산하는 유연성 확보
  - 해당 지역에 따라 운영 커스터마이징 가능
- 추가질문 : 시간대 유형별 검색
  - 지오해시를 통해 사업장을 조회하고 사업장 유형에 따라 필터링을 한다.

---

## 알게 된 키워드
- 지오해시
- 쿼드트리
- 캐시, 샤딩 도입의 이유와 우회방안
- 배포전략 : 블루/그린 전략의 트래픽 폭주 위험