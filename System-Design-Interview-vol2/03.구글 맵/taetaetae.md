# 3장 구글 맵

## 1단계 : 문제 이해 및 설계 범위 확정
- 기능 요구 사항
  - 사용자 위치 갱신
  - 경로 안내 서비스 (ETA 서비스 포함)
  - 지도 표시
- 비기능 요구사항 및 제약사항
  - 정확도 : 정확한 경로 안내
  - 부드러운 경로 표시 : 자연스러운 갱신
  - 데이터 및 배터리 사용량 : 모바일 단말이라는 제한
  - 일반적인 가용성 및 규모 확장성
- 지도 101
  - 측위 시스템
    - 위도 : 얼마나 북/남쪽인지
    - 경도 : 얼마나 동/서쪽인지
  - 3차원 위치의 2차원 반환 : 지도투영법 또는 도법
  - 지오코딩
    - 주소를 지리저거 측위 시스템의 좌표로 변환
    - 미국 어딘가 ↔︎ 위도 xx.x, 경도 yy.y 
  - 지오해싱
    - 지도 위 특정 영역을 영무낮와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체걔
    - 재귀적으로 분할해 나가며 더 자세히 표현
  - 경로 안내 알고리즘을 위한 도로 데이터 처리
    - 모든 경로 탐색 알고리즘은 교차로를 노드로, 도로는 노드로 잇는 선으로 표현하는 그래프 자료 구조를 가정
    - 지오해싱과 비슷한 분할 기술을 적용하여 세계를 작은 격자로 나누고, 각 격자 안의 도로망을 노드(교차로)와 선(도로)으로 구성된 그래프 자료 구조로 변환
    - 각 격자는 경로 안내 타일이라 부름
    - 경로 안내 타일단위로 분할해 놓으면 경로 탐색 성능에 좋음(처리범위, 필요한 만큼 로딩
- 개략적 규모 추정
  - 저장소 용량
    - 저장해야할 정보 : 세계지도, 메타 데이터, 도로정보
    - 세계 지도를 21번 확대하여 볼 수 있으려면 약 4.4조개의 타일이 필요
    - 한장당 100kb로 가정하면 타일은 440PB 만큼의 저장 공간이 필요
    - 지구 표면의 90%가 자연. 확대 수준에 따라 계산하면 대략 100PB 정도가 필요
  - 서버 대역폭
    - 경로 안내 요청과 위치 갱신 요청
    - DAU 10억, 평균 주당 35분, 15초마다 한번씩 위치 갱신 =~ 약 백만 QPS

## 2단계 : 개략적 설계안 제시 및 동의 구하기
- 개략적 설계안
  - 위치 서비스(location service)
    - 매 초마다 위치 갱신 : 해당 데이터 스트림으로 다양하게 활용 가능하지만 네트워크 비용 발생
    - 위치 갱신 정보를 담아 두었다가 한번에 일괄 요청
      > 일괄 요청하면 그 사이의 이벤트는 서비스 적으로 어떻게 처리하게 되는걸까?
    - 높은 쓰기 요청 빈도에 최적화 되어있고 규모 확장이 용이한 카산드라가 필요
    - 카프카 같은 스트림 처리엔진으로 위치 데이터를 로깅
    - http + keep alive 옵션으로 통신
      > keep alive 를 on 하면 동접 처리에 어렵지 않을까? 메모리 부하도 심할텐데 ... 역시 킹 장비 빨인가
  - 경로 안내 서비스(navigation service)
    - A에서 B로 가는 경로 제공
      > 서울역 > 부산역, 차량이동
      > 
      > 네이버 : 2.31s , 429kb
      > 
      > 카카오 : 2.15s, 33.5kb
  - 지도 표시(map rendering)
    - 방안 1 : 동적으로 생성
      - 서버 부하 심함
      - 캐시 활용 어려움
    - 방안 2
      - 미리 만들어 두고 지오 해시 url로 변환
      - POP(Point Of Presence) 활용
      - 캐시 + 응답 속도 감소
      > 네이버 : https://map.pstatic.net/nrb/styles/basic/1705624166/16/55904/25434.png?mt=bg.ol.ts.lko
      > 
      > 카카오 : https://map.daumcdn.net/map_k3f_prod/bakery/image_map_png/PNG01/v24_mq2jf/3/1893/931.png
    - 위/경도 및 확대 수준에 따른 적절한 지오해시 계산 알고리즘
      - 별도의 서비스로 분리
      - 운영 유연성 증가

## 3단계 : 상세 설계
- 데이터 모델
  - 경로 안내 타일
    - 외부에서 제공한것을 이용
    - 그래프의 노드와 선분으로 표현된 해당 지역 내 교차로와 도로 정보가 들어있음
    - 메모리에 인접 리스트 형태로 보관하는게 일반적이나 양이 너무 많음 > S3같은 객체 저장소에 파일을 보관, 캐싱후 직렬화 형태로 분류 
  - 사용자 위치
    - 다른 곳에서 활용(교통상황 갱신 및 이력 등)
    - 쓰기 연산이 많고 수평적 확장 가능한 : 카산드라
  - 지오코딩 데이터
    - 키-값 저장소 형태, 읽기가 많고 쓰기가 드뭄
  - 미리 계산해 둔 지도 타일 데이터
    - CDN 및 캐싱 활용
- 서비스
  - 위치서비스
    - CAP정리에 따라 일관성(Consistency), 가용성(Availability), 분할 내성(Partition tolerance) 모두 만족은 어려움
    - 과거의 데이터는 무시됨. 가용성과 분할내성 두가지를 만족 시키는데 집중
    - 높은 가용성을 보장하면서 막대한 규모의 연산을 감당 : 카산드라
    - 데이터 베이스 키 : user_id + timestamp
  - 사용자의 데이터는 어떻게 이용되는가
    - 카프카 스트림처리 : 각자 용도에 맞춰 활용(실시간 교통 상황, 개인화, 경로안내 등)
- 지도 표시
  - 지도 타일을 사전에 계산하여 만들어둠 (확대수준 1단계씩 늘릴 때마다 해상도는 4배씩 증가)
  - 해당 확대 수준의 지도만 다운
  - 벡터 사용 : 이미지 압축률, 매끄러운 경험
- 경로 안내 서비스
  - 지오코딩 서비스 : 주소를 위도와 경도 쌍으로 바꿔줌
  - 경로계획 서비스 : 교통 상태, 도로 상황에 입각하여 최적화된 경로 제안
  - 최단 경로 서비스 : A* 알고리즘, 출발지 타일에서 그래프 자료구조를 탐색
  - 예상 도착 시간 서비스 : 최단 경로 목록을 수신하면 ETA 추정치를 계산
  - 순위 결정 서비스 : 여러가지 복잡한 상황에서의 랭킹 및 필터링
  - 카프카 위치 데이터 스트림을 구독하고 있다가 각자에 책임/관심에 맞춰 업데이트 처리
  - 적응형 ETA와 경로 변경
    - 경로에 문제가 생겼을때 이용중인 사용자에게 알려주는 방안
    - 사용자 : 경로 형태의 db : O(m x n)
    - 경로 안내 타일 확대 수준으로 그룹화, 관련 타일에 해당하는 사용자 대응 : O(n)
      > 문제와 해결시에 따른 사용자 처리가 꽤나 복잡할듯
- 전송 프로토콜
  - 푸시 : 데이터 사이즈 제한
  - 롱 폴링 : 서버에 부담
  - SSE : 단방향
  - 웹 소켓 : 양방향 처리에 능함
    > 연결 유지에 대한 문제는 없을까?
  
## 알게 된 키워드
- 카산드라 : 대량 쓰기 요청과 수평적 확장
- CAP 정리