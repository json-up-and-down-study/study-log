# 지표 모니터링 및 경보 시스템
* 잘 설계된 지표 모니터링 및 경보 시스템은 인프라의 상태를 선명하게 볼 수 있도록 하여 높은 가용성과 안정성을 달성하는 데 중추적 역할을 한다
* 대표적으로
  * datadog, influxdb, nagios, prometheus, grafana, graphite등이 있다
## 1단계: 문제 이해 및 설계 범위 확정
* 설계 범위 확정에 도움이 될 만한 질문을 통해 설계 범위를 확정해보자
* 질문 : 시스템의 고객은 누구인가요? 대형 IT 업체의 회사 내부용 시스템인가요? 아니면 Datadog이나 Splunk와 같은 SaaS 제품인가요?
  * 답변 : 회사 내부용 시스템이라고 가정하겠습니다
* 질문 : 어떤 지표를 수집해야 하나요?
  * 답변 : 시스템 운영 지표를 수집해야 합니다. CPU부하, 메모리 사용률, disk 사용량 같은 저수준의 운영체제 사용률 지표일 수도 있고,
  서버가 처리하는 초당 요청 수나 웹 서버 프로세스 개수 같은 고차원적 개념에 관계된 지표일 수도 있습니다. 하지만 사업 지표는 시스템이 처리해야할 지표가 아닙니다
* 질문 : 모니터링할 인프라 규모는 어느 정도인가요?
  * 답변 : 일간 능동 사용자 수는 1억명이고, 1000개의 서버 풀이 있고 풀마다 100개의 서버 하드웨어를 유지하고 있습니다
* 질문 : 지표 데이터는 얼마나 오래 유지해야 하나요?
  * 답변 : 1년 동안은 보관해야 합니다
* 질문 : 장기 보관으로 옮길때 지표의 해상도를 낮추어도 되나요?
  * 답변 : 좋은 질문입니다, 새로 수집한 데이터는 7일 동안 보관하고, 7일뒤에는 1분 단위로 30일간 보관하고 그 뒤에는 1시간 단위로 변환해서 보관하는 것으로 하겠습니다
* 질문 : 경보 채널로 필요한 것들은 어떤것이 있나요?
  * 답변 : 이메일, 전화, 페이저듀티, 웹훅 등을 지원하는 것으로 하겠습니다
* 질문 : 에러나 액세스에 대한 로그 수집도 가능해야 하나요?
  * 답변 : 제외합니다
* 질문 : 분산 시스템 추적도 가능해야 하나요?
  * 답변 : 필요 없습니다

> 예상되는 도메인
> 
> 수집, 저장, 뷰어, 경고

### 개략적 요구사항 및 가정
* 대규모 인프라를 모니터링 해야 함
  * 일간 능동 사용자 1억명
  * 서버 풀 1000개 풀당 서버 100개, 서버당 100개의 운영 지표
    * 지표의 수는 대략 1000 * 100 * 100으로 천만개
  * 데이터 보관 기간은 1년
  * raw는 일주일 그 뒤는 1분으로 30일간, 그 두는 1시간 단위로 1년간
* 모니터링할 지표 예시
  * cpu 사용률
  * 요청 수
  * 메모리 사용량
  * 메시지 큐 내의 메시지 수

### 비기능 요구사항
* 규모 확장성 : 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 한다
* 낮은 응답 지연 : 대시보드와 경보를 신속하게 처리할 수 있게 질의에 대한 낮은 응답 지연을 보장해야 한다
* 안정성 : 높은 안정성을 제공하여 중요 정보를 놓치지 않도록 해야 한다
* 유연성 : 유연하게 변경 가능한 파이프라인을 이용해 구축한 시스템이어야 한다
* 아래는 고려하지 않아도 된다
  * 로그 모니터링
  * 분산 시스템 추적

## 2단계: 개략적 설계안 제시 및 동의 구하기 
### 기본적 사항
* 일반적으로 필요한 컴포넌트(도메인)을 예상해본다
* 데이터 수집 : 지표 데이터를 수집한다
* 데이터 전송 : 지표 데이터를 모니터링 시스템으로 전송한다
* 데이터 저장소 : 전송되어 오는 데이터를 정리하고 저장한다
* 경보 : 데이터를 분석하고 이상 징후를 감지하고 경보를 발생 시킨다, 다양한 채널로 경보를 발송할 수 있어야 한다
* 시각화 : 데이터를 차트나 그래프 등으로 제공한다

### 데이터 모델
* 지표는 통상 시계열 데이터 형태로 기록한다

* 예시 1 : cpu load에 대한 데이터와 레이블

| metric_name |      cpu.load       |
|:-----------:|:-------------------:|
|   labels    | host:i631, env:prod |
|timestamp|161423121|
|value|0.29|

* 예시 2 : 지난 10분의 cpu load 평균값을 얻기 위해서는 어떻게 해야 할까?
```shell
CPU.load host=webserver01,region=us-west 1613707265 50
CPU.load host=webserver01,region=us-west 1613707265 62
CPU.load host=webserver02,region=us-west 1613707265 43
CPU.load host=webserver02,region=us-west 1613707265 53
...
CPU.load host=webserver01,region=us-west 1613707265 76
CPU.load host=webserver01,region=us-west 1613707265 83
```
* 각 행의 마지막에 기록된 cpu 부하 수치의 평균을 구하면 된다
  * 50+62+43+...83 / n

|         이름         |        자료형        |
|:------------------:|:-----------------:|
|       지표 이름        |        문자열        |
|     태그/레이블 집합      |   <키:값> 쌍의 리스트    |
| 지표 값 및 그 타임스탬프의 배열 | <값, 타임스탬프> 쌍의 배열> |

* 데이터 접근 패턴
  * 쓰기 부하는 시간의 흐름에 따라 일정하게 매우 많이 발생한다
  * 대부분의 I/O는 쓰기로 발생한다
  * 반면 읽기는 스파이크 패턴을 보인다
    * 일시적으로 증가했다가 요청이 없어질 수 있다

* 데이터 저장소 시스템
  * 시스템을 직접 설계하거나 MySQL과 같은 범용 저장소 시스템을 사용하는 것 모두 추천하지 않는다
    * 시계열 데이터를 대상으로 하는 연산에 최적화되어 있지 않기 때문
    * 
