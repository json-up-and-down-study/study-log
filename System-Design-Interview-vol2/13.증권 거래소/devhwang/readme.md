# 증권 거래소
* 거래소는 다양한 유형이 존재한다.
* 설계에 뛰어들기 전 면접관에게 질문을 던져 거래소 규모 등 중요 특징을 먼저 확인하자

## 1단계: 문제 이해 및 설계 범위 확정
* 증권 걸소는 지연 시간, 처리량, 안정성에 대한 요구사항이 엄격한 복잡한 시스템이다.
* Q : 어떤 증권을 거래한다고 가정할 것인가?
  * A : 주식만 거래한다
* Q : 새 주문, 주문 취소, 주문 수정, 지정가 주문..등 모든 주문 유형을 지원해야 하는가?
  * A : 새 주문, 주문 취소, 지정가 주문이 가능해야 한다
* Q : 시간 외 거래가 가능해야 하는가?
  * A : 아니다
* Q : 사용자 수, 증권 수, 주문 수등 규모에 대한 부분도 설명해주세요
  * A : 주문이 체결된 경우 실시간으로 파악할 수 있어야 한다. 호가 창의 정보는 실시간 갱신되어야 한다. 최소 수만 명 사용자가 동시에 거래할 수 있어야 하며, 100가지 주식 거래가 가능해야 한다.
거래량은 하루 수십억 건이상 발생할 수 있고, 규제 시설이므로 위험성 점검이 가능해야 한다.
* Q : 위험성 점검에 대해 조금 더 자세히.
  * A : 사용자가 하루 거래할 수 있는 애플 주식이 100만 주 이하라는 규제가 있을때 규제를 위반하는 거래가 이루어지지 않도록 하면 된다.
* Q : 사용자 지갑에 대한 고려가 필요한가?
  * A : 주문 전에 충분한 자금이 있는지, 아직 체결되지 않은 주문이 있는 경우 해당 주문에 이용된 자금은 다른 주문에 쓰일 수 없어야 한다.

### 비기능 요구사항
* 가용성(Availability) : 최소 99.99%
* 결함 내성(Fault tolerance) : 프로덕션 장애의 파급을 줄이기 위한 결함 내성과 빠른 복구 메커니즘
* 지연 시간(latency) : 왕복 지연 시간은 ms 수준이어야 하며, 특히 p99 지연시간이 중요하다.
* 보안(security) : 거래소는 계정 관리 시스템을 갖추어야 한다. 법률 및 규정 준수도 중요한 문제다.

### 개략적 규모 추정
* 100가지 주식
* 하루 10억 건 주문
* 영업시간 (NYSE 기준 6.5시간)
* QPS : 10억 / 6.5시간 x 3600 =~ 43,000
* 최대는 5배수로 215,000로 가정한다. 거래량은 장 시작 직후, 마감 직전에 스파이크 친다.

## 2단계: 개략적 설계안 제시 및 동의 구하기
### 증권 거래 101
* 브로커 : 증권사
* 기관 고객 : 대량 거래를 수행하는 고객, 거래 빈도는 낮고 거래량이 많다. 시장 영향을 줄이기 위한 주문 분할과 같은 기능이 필요하다.
일반 고객보다 특별히 더 낮은 latency를 원한다.
* 지정가 주문 : 가격이 고정된 매수 또는 매도 주문, 즉시 이루어지지 않을 수 있고, 부분만 체결될 수도 있다.
* 시장가 주문 : 가격을 지정하지 않는 주문으로 즉시 체결된다.
* 시장 데이터 수준 : 미국 기준 L1, L2, L3  세 가지 가격 정보 등급이 있다.
  * L1 : 최고 매수 호가, 매도 호가, 수량
  * L2 : L1 + 물량
  * L3 : L2 + 각 가격별 물량
* 봉 차트 : 특정 기간 동안의 주가, 최고가, 시작가, 종가, 최저가를 표현한다. 1분,5분,1시간,1일,1주,1개월..
* FIX : 금융 정보 교환 프로토콜

### 개략적 설계안
* ![img.png](img.png)
#### Trading flow
1. 고객이 브로커의 웹 또는 앱을 통해 주문한다.
2. 브로커가 주문을 거래소에 전송한다.
3. 주문이 클라이언트 게이트웨이를 통해 거래소로 들어간다.
   1. 여기서 입력 유효성, 속도 제한(?), 인증, 정규화와 같은 기본 게이트키핑 기능을 수행한다.
4. 위험 관리자가 설정한 점검을 수행한다.
5. 지갑에 자금이 충분한지 확인한다.
6. 주문이 체결 엔진으로 전송된다. 매수,매도 측에 각각 두 개의 집행 기록을 생성한다. 시퀀서는 주문 및 집행 기록을 일정 순서로 정렬한다.
7. 주문 집행 사실을 클라이언트에 전송한다.

#### Market data flow
* M1. 체결 엔진은 주문이 체결되면 집행 기록 스트림을 만든다. 그리고 시장 데이터 게시 서비스로 전송한다.
* M2. 시장 데이터 게시 서비스는 집행 기록 및 주문 스트림에서 얻은 데이터를 시장 데이터로 사용하여 봉/호가 창을 구성한다. 그리고 데이터 서비스로 보낸다.
* M3. 시장 데이터는 실시간 분석 전용 스토리지에 저장된다. 브로커는 데이터 서비스를 통해 실시간 시장 데이터를 읽는다.

#### Report flow
* 보고 서비스는 주문 및 실행 기록에서 보고에 필요한 모든 필드의 값을 모은 다음 그 값을 종합해 만든 레코드를 데이터베이스에 기록한다.

**중요한 것은 각 flow는 지연 시간 요구 사항이 다르다**

### Tradig flow
#### 체결 엔진
* matching engine, cross engine
1. 각 주식 심벌에 대한 주문서나 호가 창을 유지 관리한다. 이것은 특정 주식에 대한 매수 및 매도 주문 목록이다.
2. 매수 주문과 매도 주문을 연결한다.
3. 집행 기록 스트림을 시장 데이터로 배포한다.
* 여기서 만들어지는 체결 순서는 결정론적이어야 한다. 입력으로 주어지는 주문 순서가 같으면 체결 엔진이 만드는 집행 기록 순서는 언제나 동일해야 한다.
#### Sequencer
* 체결 엔진을 결정론적으로 만드는 핵심 구성 요소