## 13장. 증권거래소

### 1단계 : 문제 이해 및 설계 범위 확정

- 개략적 규모 추정
    - 100가지 주식
    - 하루 10억건의 주문
    - 월\~금, 오전 9시30분\~오후4시 총 6.5시간 영업
    - QPS = 10억/6.5시간x3600=~43,000
    - 최대 QPS : 5 x QPS = 215,000 (장 시작 직후, 장 마감 직전)
- 비기능 요구사항
    - 가용성 : 최소 99.99%
    - 결함 내성과 빠른 복구 매커니즘
    - 왕복 지연시간은 밀리초 수준
    - 계정 관리 시스템 필요

### 2단계 : 개략적 설계안 제시 및 동의 구하기

- 증권 거래 101
    - 기관고객
    - 지정가 주문, 시장가 주문
    - 시장데이터 수준 (L1 < L2 < L3)
    - 봉차트
- 개략적 설계안
    - 빨라야 한다.
    - 거래흐름
        - 체결 엔진
            - 각 주식 심벌에 대한 주문서 내지 호가창을 유지 관리
            - 매수주문과 매도주문을 연결
            - 집행 기록 스트림을 시장 데이터로 배포
        - 시퀀서
            - 순서 ID를 붙임
            - 이유
                - 시의성 및 공정성
                - 빠른 복구 및 재생
                - 정확한 1회 실행 보증
        - 주문관리자
            - 한쪽에서 주문을 받고 다른 쪽에서는 집행 기록을 받음
            - 주문 상태를 관리하는 역할
        - 클라이언트 게이트웨이
            - 클라이언트로부터 주문을 받아 주문 관리자에게 보냄
            - 인증, 유효성 검사, 처리율 제한, 정규화 기능
            - 지연시간에 민감하고 가벼워야 함
    - 시장데이터 흐름 : 하나의 주문이 체결 엔진부터 데이터 서비스를 거쳐 브로커로 전달되어 집행되기까지의 과정
        - 호가창과 봉 차트를 생성
    - 보고흐름 : 거래 이력, 세금 보고, 규정 준수 여부 보고, 결산 등
- API  설계
    - 주문
    - 집행
    - 호가 창/주문서
    - 가격 변동 이력(봉차트)
- 데이터 모델
    - 상품,주문 및 집행
        - Order 1↔1 Product
        - Order 1 ↔ 0..n Execution
    - 호가 창/주문서
        - O(1) 속도 요구
        - 좀더 빠른 속도를 위해
            - List도 Doubly Linked list
            - Map 도 LinkedHashMap
    - 봉 차트
        - 많은 종목의 가격 이력을 다양한 시간 간격을 사용해 추적하려면 메모리에 보관
        - 메모리 두는 개수 제한, 나머지는 디스크에

### 3단계 : 상세 설계

- 성능
    - 빨라야 함
    - 지연시간 최소화
        - 중요 경로에서 실행할 작업의 수를 줄인다.
        - 각 작업의 소요시간을 줄인다. (네트워크 및 디스크 사용량, 각 작업의 실행 시간)
    - 같은 서버 내 컴포넌트 간 통신은 이벤트 저장소인 mmap 을 활용
        - mmap
            
            메모리의 내용을 파일이나 디바이스에 대응(mapping)하기 위해서 사용하는 시스템 호출이다.
            
    - 어플리케이션 루프
        - 단일 스레드로 구현, cpu에 고정, 폴링
            - 장점
                - 컨텍스트 스위칩 이용 없음
                - 락, 잠금 경합 없음
            - 단점
                - 코딩이 복잡해짐
        - 이벤트 소싱의 활용
            - 모든 이벤트를 추적하므로 순서대로 재생하면 주문상태 복구 가능
            - pub/sub과 비슷
            - 지연시간에 대한 엄격한 요구사항이 없었다면 카프카 사용 가능
        - 고가용성
            - 단일 장애 지점 식별
            - 장애 감지 및 백업 인스턴스로의 장애 조치 결정이 빨라야 함
        - 결함 내성
            - 주/부 전환
            - 리더 선출
            - 복구시간 목표
            - 어떤 기능을 복구해야 하는가
            - 카오스 엔지니어링 활용
        - 체결 알고리즘
            - 선입선출 활용
        - 결정론
            - 시퀀서나 이벤트 소싱 아키텍처를 도입함으로써 이벤트를 동일한 순서로 재생하면 항상 결과를 얻을 수 있도록 보장
            - 실제 시간 보다 순서가 중요
        - 시장 데이터 게시 서비스 최적화
        - 시장 데이터의 공정한 배포
        - 코로케이션
        - 네트워크 보안
